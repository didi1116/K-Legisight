#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
search_similar_bills.py
=========================================================
üìå Î™©Ï†Å:

ÏûÖÎ†•Îêú Î≤ïÏïà ÌÇ§ÏõåÎìú ÏûÑÎ≤†Îî©(query_embedding)ÏùÑ Í∏∞Ï§ÄÏúºÎ°ú,
Í≥ºÍ±∞ Î≤ïÏïà ÏûÑÎ≤†Îî©Í≥ºÏùò ÏΩîÏÇ¨Ïù∏ Ïú†ÏÇ¨ÎèÑÎ•º Í≥ÑÏÇ∞ÌïòÏó¨

‚ñ∂ ÏùòÎØ∏Ï†ÅÏúºÎ°ú Ïú†ÏÇ¨Ìïú Î≤ïÏïà ÌõÑÎ≥¥Íµ∞ÏùÑ Î∞òÌôòÌïúÎã§.

üìå ÌïµÏã¨ ÏÑ§Í≥Ñ Ï≤†Ìïô (Ï§ëÏöî):

- Ïú†ÏÇ¨ÎèÑÎäî "Í∞ïÎèÑ"Í∞Ä ÏïÑÎãàÎùº "ÏùòÎØ∏Ï†Å ÏùºÏπò Ïó¨Î∂Ä"Î•º ÌåêÎã®ÌïòÎäî Í∏∞Ï§ÄÏù¥Îã§.
- ÎÑàÎ¨¥ ÎÇÆÏùÄ Ïú†ÏÇ¨ÎèÑÏùò Î≤ïÏïàÏùÄ ÏòàÏ∏° Í∑ºÍ±∞Î°ú ÏÇ¨Ïö©ÌïòÎ©¥ Ïïà ÎêúÎã§.
- Í∑∏Îü¨ÎÇò Î∂ÑÏÑù ÏûêÏ≤¥Í∞Ä Î©àÏ∂îÎäî Í≤ÉÎèÑ ÌóàÏö©ÌïòÏßÄ ÏïäÎäîÎã§.

Îî∞ÎùºÏÑú:
‚úî 2Îã®Í≥Ñ ÌïÑÌÑ∞ÎßÅ Ï†ÑÎûµÏùÑ ÏÇ¨Ïö©ÌïúÎã§.
=========================================================
"""

import numpy as np
import pandas as pd
from sklearn.metrics.pairwise import cosine_similarity


def search_similar_bills(
    query_embedding,
    bill_df,
    strict_threshold: float = 0.6,
    soft_threshold: float = 0.45,
    min_evidence: int = 5
):
    """
    üîç Ïú†ÏÇ¨ Î≤ïÏïà Í≤ÄÏÉâ (2Îã®Í≥Ñ ÌïÑÌÑ∞ Ï†ÑÎûµ)

    Parameters
    ----------
    query_embedding : np.ndarray (1, dim)
    ...
    """

    # --------------------------------------------------
    # üîë Ï†àÎåÄ ÏµúÏÜå ÏùòÎØ∏ Ïú†ÏÇ¨ÎèÑ Ïª∑ (Í∑ºÍ±∞ ÏûêÍ≤© Ï°∞Í±¥)
    # --------------------------------------------------
    ABSOLUTE_MIN_SIM = 0.46

    # --------------------------------------------------
    # 1. ÏûÑÎ≤†Îî© ÌñâÎ†¨ Íµ¨ÏÑ±
    # --------------------------------------------------
    bill_embeddings = np.vstack(bill_df["embedding"].values)

    # --------------------------------------------------
    # 2. ÏΩîÏÇ¨Ïù∏ Ïú†ÏÇ¨ÎèÑ Í≥ÑÏÇ∞
    # --------------------------------------------------
    similarities = cosine_similarity(
        query_embedding,
        bill_embeddings
    )[0]

    df = bill_df.copy()
    df["similarity"] = similarities

    # üîë Ïó¨Í∏∞ÏÑú Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏÇ¨Ïö©Îê®
    df = df[df["similarity"] >= ABSOLUTE_MIN_SIM]



    # --------------------------------------------------
    # 3. 1Ï∞® ÌïÑÌÑ∞ (ÏóÑÍ≤©Ìïú ÏùòÎØ∏ ÏùºÏπò)
    # --------------------------------------------------
    strict_candidates = df[df["similarity"] >= strict_threshold]

    if len(strict_candidates) >= min_evidence:
        return strict_candidates.sort_values(
            "similarity", ascending=False
        )

    # --------------------------------------------------
    # 4. 2Ï∞® ÌïÑÌÑ∞ (ÏôÑÌôîÎêú ÏùòÎØ∏ ÏùºÏπò)
    # --------------------------------------------------
    soft_candidates = df[df["similarity"] >= soft_threshold]

    if len(soft_candidates) >= min_evidence:
        return soft_candidates.sort_values(
            "similarity", ascending=False
        )

    # --------------------------------------------------
    # 5. Í∑ºÍ±∞ Î∂ÄÏ°± ‚Üí Î∂ÑÏÑù Î∂àÍ∞Ä
    # --------------------------------------------------
    return pd.DataFrame()
