#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
build_party_bill_ranking.py
==============================================================
ğŸ“Œ ëª©ì :
ì •ë‹¹ë³„ë¡œ "ëª¨ë“  ë²•ì•ˆì˜ í˜‘ë ¥ë„ ìˆœìœ„ë¥¼ ì™„ì „í•œ í˜•íƒœë¡œ" ìƒì„±í•˜ì—¬ CSVë¡œ ì €ì¥í•œë‹¤.

âœ” ì™œ í•„ìš”í•œê°€?
- ì •ë‹¹ì´ ì–´ë–¤ ë²•ì•ˆì„ ê°€ì¥ í˜‘ë ¥ì ìœ¼ë¡œ ëŒ€í–ˆëŠ”ì§€(ìƒìœ„ 5)
- ì–´ë–¤ ë²•ì•ˆì— ê°€ì¥ ë¹„í˜‘ë ¥ì ì´ì—ˆëŠ”ì§€(í•˜ìœ„ 5)
- ì¤‘ìœ„ê¶Œ ë²•ì•ˆì€ ì–´ë–¤ ê²ƒë“¤ì¸ì§€
ì´ë¥¼ UIì—ì„œ ê°„ë‹¨í•˜ê²Œ í•„í„°ë§í•  ìˆ˜ ìˆë„ë¡,
ì „ì²´ ë²•ì•ˆ ëª©ë¡ì„ ì •ë‹¹ë³„ ìˆœìœ„ë¡œ êµ¬ì¡°í™”í•´ ì œê³µí•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì´ë‹¤.

âœ” í•µì‹¬ ê¸°ëŠ¥ ìš”ì•½:
1) all_party.pkl ë¡œë“œ â†’ bill_review ë¦¬ìŠ¤íŠ¸ explode
2) util_bill.parse_bill_string() ì‚¬ìš©í•´ robust ë²•ì•ˆëª…/ì˜ì•ˆë²ˆí˜¸ íŒŒì‹±
3) ì •ë‹¹ Ã— ë²•ì•ˆ ë‹¨ìœ„ë¡œ í˜‘ë ¥ë„ í‰ê·  ê³„ì‚°
4) ë°œì–¸ìˆ˜ê°€ ì ì–´ì„œ í‰ê· ì´ íŠ€ëŠ” ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´
   â†’ ë² ì´ì‹œì•ˆ ë³´ì • ì ìˆ˜(bayesian_score) ì ìš©
5) ì •ë‹¹ ë‚´ë¶€ rank 1~N ì „ì²´ ë¶€ì—¬
6) CSV ì €ì¥ â†’ UIì—ì„œ top5 / bottom5 ì‰½ê²Œ í•„í„°ë§ ê°€ëŠ¥

ğŸ“Œ ì…ë ¥:
  ./output_party/all_party.pkl
    â†’ b_load_party_data.py ì—ì„œ ìƒì„±ëœ ìµœì¢… ë°œì–¸ ë°ì´í„°

ğŸ“Œ ì¶œë ¥:
  ./output_party/party_bill_ranking.csv

ğŸ“Œ ìµœì¢… CSV ì»¬ëŸ¼ êµ¬ì¡°:
  party_name        : ì •ë‹¹ëª…
  bill_name         : ì •ì œëœ ë²•ì•ˆëª…
  bill_number       : ì˜ì•ˆë²ˆí˜¸ (ì—†ì„ ê²½ìš° None)
  speech_count      : í•´ë‹¹ ì •ë‹¹ì˜ ë²•ì•ˆ ë°œì–¸ ìˆ˜
  avg_score_prob    : ì›ë˜ í‰ê·  í˜‘ë ¥ë„ (coop - noncoop)
  bayesian_score    : ë°œì–¸ëŸ‰ì„ ê³ ë ¤í•œ ì•ˆì •ì  ì ìˆ˜
  rank_in_party     : bayesian_score ê¸°ì¤€ ì •ë‹¹ ë‚´ë¶€ ìˆœìœ„ (1ë“± = ìµœê³  í˜‘ë ¥)
==============================================================
"""

import os
import pandas as pd
from util_bill import parse_bill_string


# ==============================================================  
# ê²½ë¡œ ì„¤ì •
# ==============================================================  
INPUT_PICKLE = "./output_party/all_party.pkl"
OUTPUT_CSV   = "./output_party/party_bill_ranking.csv"


# ==============================================================  
# ë² ì´ì‹œì•ˆ ë³´ì • í•¨ìˆ˜
# ==============================================================  
def bayesian_adjusted_score(avg, n, baseline=0.0, weight=30):
    """
    ë² ì´ì‹œì•ˆ ì ìˆ˜ ê³„ì‚° ê³µì‹:
    
       score = (avg * n + baseline * weight) / (n + weight)

    âœ” avg      : ë²•ì•ˆì˜ ì›ë˜ í‰ê·  í˜‘ë ¥ë„
    âœ” n        : í•´ë‹¹ ë²•ì•ˆì— ëŒ€í•œ ë°œì–¸ ìˆ˜
    âœ” baseline : ëª¨ë“  ë²•ì•ˆì˜ ì „ì²´ í‰ê·  í˜‘ë ¥ë„
    âœ” weight   : ë°œì–¸ ìˆ˜ê°€ ì ì„ ë•Œ baselineì´ ì–¼ë§ˆë‚˜ ì˜í–¥ì„ ì¤„ì§€ ê²°ì • (ê¸°ë³¸ 30)

    â†’ ë°œì–¸ìˆ˜ê°€ ì ìœ¼ë©´ baselineì— ê°€ê¹Œì›Œì ¸ì„œ ì ìˆ˜ íŠ ë°©ì§€
    â†’ ë°œì–¸ìˆ˜ê°€ ë§ìœ¼ë©´ avgë¥¼ ê±°ì˜ ê·¸ëŒ€ë¡œ ë°˜ì˜í•¨
    """
    return (avg * n + baseline * weight) / (n + weight)


# ==============================================================  
# ë©”ì¸ ì‹¤í–‰ë¶€
# ==============================================================  
if __name__ == "__main__":

    print("\n[INFO] ì •ë‹¹ë³„ ë²•ì•ˆ í˜‘ë ¥ë„ ì „ì²´ ìˆœìœ„í‘œ ìƒì„± ì‹œì‘...")

    # ----------------------------------------------------------
    # 1) ë°ì´í„° ë¡œë“œ
    # ----------------------------------------------------------
    if not os.path.exists(INPUT_PICKLE):
        raise FileNotFoundError(f"[ERROR] íŒŒì¼ ì—†ìŒ: {INPUT_PICKLE}")

    df = pd.read_pickle(INPUT_PICKLE)

    # ì •ë‹¹ ë¯¸ë§¤ì¹­ ì œê±°
    df = df[df["party_name"].notna()].copy()

    if df.empty:
        raise RuntimeError("[ERROR] ì •ë‹¹ ë§¤ì¹­ëœ ë°œì–¸ì´ ì—†ìŠµë‹ˆë‹¤.")

    # bill_review ê°€ ë¹ˆ ë¦¬ìŠ¤íŠ¸ê±°ë‚˜ None â†’ ì œê±°
    df = df[df["bill_review"].apply(lambda x: isinstance(x, list) and len(x) > 0)]

    # bill_review ë¦¬ìŠ¤íŠ¸ explode (ë²•ì•ˆ 1ê°œì”© í•œ í–‰)
    df = df.explode("bill_review")


    # ----------------------------------------------------------
    # 2) util_bill í™œìš©í•˜ì—¬ ë²•ì•ˆëª… / ì˜ì•ˆë²ˆí˜¸ íŒŒì‹±
    # ----------------------------------------------------------
    print("[INFO] ë²•ì•ˆ ë¬¸ìì—´ íŒŒì‹± ì¤‘...")

    df["bill_name"], df["bill_proposer"], df["bill_number"] = zip(
        *df["bill_review"].apply(parse_bill_string)
    )

    # bill_name ì—†ëŠ” ê²½ìš° ì œê±° (ê±°ì˜ ì—†ìŒ)
    df = df[df["bill_name"].notna()]


    # ----------------------------------------------------------
    # 3) ì •ë‹¹ Ã— ë²•ì•ˆ ë‹¨ìœ„ í†µê³„ ê³„ì‚°
    # ----------------------------------------------------------
    print("[INFO] ì •ë‹¹ Ã— ë²•ì•ˆ ë‹¨ìœ„ í˜‘ë ¥ë„ ì§‘ê³„ ì¤‘...")

    grouped = (
        df.groupby(["party_name", "bill_name", "bill_number"])
        .agg(
            speech_count=("speech_id", "count"),
            avg_score_prob=("score_prob", "mean")
        )
        .reset_index()
    )

    # baseline = ëª¨ë“  ë²•ì•ˆ í‰ê·  í˜‘ë ¥ë„
    baseline = grouped["avg_score_prob"].mean()


    # ----------------------------------------------------------
    # 4) ë² ì´ì‹œì•ˆ ì ìˆ˜ ê³„ì‚°
    # ----------------------------------------------------------
    grouped["bayesian_score"] = grouped.apply(
        lambda r: bayesian_adjusted_score(
            avg=r["avg_score_prob"],
            n=r["speech_count"],
            baseline=baseline,
            weight=30
        ),
        axis=1
    )


    # ----------------------------------------------------------
    # 5) ì •ë‹¹ ë‚´ë¶€ ìˆœìœ„ ë¶€ì—¬
    # ----------------------------------------------------------
    print("[INFO] ì •ë‹¹ë³„ ìˆœìœ„ ê³„ì‚° ì¤‘...")

    grouped["rank_in_party"] = (
        grouped.groupby("party_name")["bayesian_score"]
               .rank(method="first", ascending=False)  # ë†’ì€ ì ìˆ˜ê°€ 1ë“±
               .astype(int)
    )

    # ì •ë‹¹ëª… â†’ ìˆœìœ„ ìˆœìœ¼ë¡œ ì •ë ¬
    grouped = grouped.sort_values(["party_name", "rank_in_party"])


    # ----------------------------------------------------------
    # 6) CSV ì €ì¥
    # ----------------------------------------------------------
    os.makedirs("./output_party", exist_ok=True)
    grouped.to_csv(OUTPUT_CSV, index=False, encoding="utf-8-sig")

    print("\n=======================================================")
    print("[SUCCESS] ì •ë‹¹ë³„ ë²•ì•ˆ ì „ì²´ ìˆœìœ„í‘œ ìƒì„± ì™„ë£Œ!")
    print(" â†’ ì €ì¥ ìœ„ì¹˜:", OUTPUT_CSV)
    print(" â†’ ì´ (ì •ë‹¹ Ã— ë²•ì•ˆ) ì¡°í•©:", len(grouped))
    print("=======================================================\n")
